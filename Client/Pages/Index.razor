@page "/"
@using System.Net.Http
@using ApiServerForTelegram.Entities.EExceptions
@using ApiServerForTelegram.Entities.IikoCloudApi.General.Menu.RetrieveExternalMenuByID
@using Newtonsoft.Json
@using System.Net
@using System.Text
@using TlgWebAppNet
@using WebAppAssembly.Client.Repositories.JsHelper
@using WebAppAssembly.Shared.Entities.EMenu
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Routing
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.JSInterop
@using WebAppAssembly.Shared.Entities.CreateDelivery
@using WebAppAssembly.Shared.Entities.Exceptions
@using WebAppAssembly.Shared.Entities.IikoCloudApi
@using WebAppAssembly.Shared.Entities.Telegram
@using WebAppAssembly.Shared.Entities.WebApp
@using WebAppAssembly.Shared.Models
@using WebAppAssembly.Shared.Models.Order
@using WebAppAssembly.Shared.Entities
@using Product = WebAppAssembly.Shared.Entities.EMenu.Product
@using WebAppAssembly.Client.Service
@inject IJSRuntime JsRuntime
@inject HttpClient Http

<PageTitle>Index</PageTitle>

@* Show the main page of shopping online after downloading the data *@
@if (IsLoadedGeneralInfo)
{
    // Show an error message when the following conditions occur
    if (OrderService is null || (OrderService.IsReleaseMode && TwaNet is null) || StateOfPage is null || StateOfPage.HaveErrors || JsHelperService is null)
    {
        <div>
            <h6 style="text-align:center;">Happened something wrong :(</h6>
        </div>
    }
    // Show operating states in case of successful data upload from the API server
    else
    {
        // General data that is used for a shopping online
        var dgi = OrderService.DeliveryGeneralInfo;

        // Show the main page for:
        // - selecting products
        // - selecting categories of products
        // - selecting the number of products
        // This page is showing categories and products with simple info (images, prices, chosed amounts and restrictions)
        if (StateOfPage.PageTypeOfOrder == PageTypeOfOrder.SelectingProducts)
        {
            // Info of categories of menu
            var itemCategories = dgi.ItemCategories;
            // Info of a some category
            TransportMenuCategoryDto? itemCategory = null;

            // Show all categories of menu
            if (itemCategories is not null && itemCategories.Any())
            {
                <h1 style="padding-top: 5px;margin-bottom: 0px;text-align: center;">
                    Категории
                </h1>
                <hr style="color:grey;margin-bottom:0px;margin-top:10px;"/>
                <div class="horizontal_slider" style="padding-left: 0px;padding-right: 0px;padding-top:5px;margin-top: 0px;padding-bottom:10px;">
                    <div class="slider_container">
                        @* When the category image is been clicked, the menu of the selected category will been shown *@
                        @foreach (var category in itemCategories)
                        {
                            // Save the category info if the some category has been selected
                            if (OrderService.CurrentGroupId is not null && category.Id == (Guid)OrderService.CurrentGroupId)
                            {
                                itemCategory = category;
                            }

                            <div class="item">
                                <div class="row" style="--bs-gutter-x:0.6rem;">
                                    <img class="img-fluid rounded" src="@category.ButtonImageUrl" alt="@category.Name" @onclick="(e => AddCurrentGroupId(category.Id))"/>
                                </div>
                                <div class="row" style="--bs-gutter-x:0.6rem;">
                                    <h6 style="text-align:center;">@category.Name</h6>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }

            // If no category in the menu has been selected, then the entire menu is shown, otherwise the menu of the selected category is shown
            var products = itemCategory is null ? dgi.TransportItemDtos : itemCategory.Items;

            // Show the menu of the selected category
            if (itemCategory is not null)
            {
                <h1 style="padding-top: 0px;margin-bottom: 0px;text-align:center;">
                    @itemCategory.Name
                </h1>
            }
            // Show the entire menu
            else
            {
                <h1 style="padding-top: 0px;margin-bottom: 0px;text-align:center;">
                    Меню
                </h1>
            }
            <hr style="color:grey;"/>

            // Show positions in three columns
            if (products is not null)
            {
                var productsArr = products.ToArray();
                // Number of columns
                const int columnAmount = 3;
                int productCount = productsArr.Length;

                for (int i = 0; i < productCount; i += columnAmount)
                {
                    <div>
                        @* Notice! Width of each column needs to changing otherwise of it. So space of each column needs to be changing (#0001) *@
                        <div class="row mt-1 mb-1" style="--bs-gutter-x:0.6rem;">
                        @for (int j = i; j < i + columnAmount; j++)
                        {
                            if (j < productCount)
                            {
                                var product = productsArr[j];

                                <div class="col">
                                    <center>
                                        <img class="img-fluid rounded" src="@product.ImageLink()" alt="@product.Name"
                                            @onclick="(e => (product.HaveModifiers() || product.HaveSizesMoreThanOne())
                                            ? AddProductItemInSelectingProductPageAsync(product.GetItemId())
                                            : AddProductWithoutModifiersForSelectingAmountsForProductsPageAsync(product.ItemId ?? Guid.Empty))" />
                                    </center>
                                    <h6 style="line-height:0.5;margin-top: 5px;">@($"₽{(product.PriceOrDefault().ToString() ?? "???")}")</h6>
                                    <p style="line-height:1;" id="@product.ItemId">@product.Name</p>
                                        <p style="line-height:0.5;color:lightgrey;margin-top:0px;" id="@product.ItemId">@(product.WeightAsString()) г</p>
                                </div>
                            }
                            else
                            {
                                <div class="col"></div>
                            }
                        }
                        </div>

                        <div class="row mb-3" style="--bs-gutter-x:0.6rem;">
                            @for (int j = i; j < i + columnAmount; j++)
                            {
                                if (j < productCount)
                                {
                                    var product = productsArr[j];
                                    <div class="col">
                                        @if (OrderService.OrderInfo.ItemByIdOrDefault(product.GetItemId()) is null)
                                        {
                                            <div class="TlBlr_div TlBlrCounter_x TlBlrDesktopProductCard_footer TlBlrCounter_y">
                                                <button @onclick="(e => AddProductItemInSelectingProductPageAsync(product.GetItemId()))" class="TlBlrCounter_btn TlBlrCounter_onlyIncrement"
                    data-testid="amount-select-increment">
                                                    <span>Добавить</span>
                                                </button>
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="TlBlr_div TlBlrCounter_x TlBlrDesctopProductCard TlBlrCounter_y">
                                                <button @onclick="(e => RemoveProductItemInSelectingProductPageAsync(product.GetItemId()))" class="TlBlrCounter_btn TlBlrCounter_decrement"
                    data-testid="amount-select-decrement">
                                                    <svg width="1em" height="1em" viewBox="0 0 24 24" fill="none" class="TlBlrIcon_y TlBlrIcon_root TlBlrCounter_icon">
                                                        <path fill-rule="evenodd" clip-rule="evenodd" d="M6 12a1 1 0 0 0 1 1h10a1 1 0 1 0 0-2H7a1 1 0 0 0-1 1Z" fill="currentColor"></path>
                                                    </svg>
                                                </button>
                                                <span>@OrderService.OrderInfo.SelectedTotalAmountByItemId(product.GetItemId())</span>
                                                <button @onclick="(e => AddProductItemInSelectingProductPageAsync(product.GetItemId()))" class="TlBlrCounter_btn TlBlrCounter_increment"
                    data-testid="amount-select-increment">
                                                    <svg width="1em" height="1em" viewBox="0 0 24 24" fill="none" class="TlBlrIcon_y TlBlrIcon_root TlBlrCounter_icon">
                                                        <path fill-rule="evenodd" clip-rule="evenodd" d="M12 6a1 1 0 0 0-1 1v4H7a1 1 0 1 0 0 2h4v4a1 1 0 1 0 2 0v-4h4a1 1 0 1 0 0-2h-4V7a1 1 0 0 0-1-1Z"
                        fill="currentColor"></path>
                                                    </svg>
                                                </button>
                                            </div>
                                        }
                                    </div>
                                }
                                else
                                {
                                    <div class="col"></div>
                                }
                            }
                        </div>                
                    </div>
                }
            }

            // Show the button for to go the shopping cart (only for test)
            if (!OrderService.IsReleaseMode)
            {
                if (OrderService.OrderInfo.HaveSelectedProducts())
                {
                    <div>
                        <center>
                            @*Show button if at least one product is selected*@
                            <a href="#" @onclick="(e => ViewOrderOfTestMode())" data-toggle="modal" data-target="#productModal" class="btn btn-success">Корзина</a>
                        </center>
                    </div>
                }
            }
        }
        // Show the page for:
        // - selecting modifiers
        // - selecting the number of the product
        // - selecting sizes of the product
        // This page is showing the product description and restrictions of the product
        // Notice! #0002
        else if (StateOfPage.PageTypeOfOrder == PageTypeOfOrder.SelectingModifiersAndAmountsForProduct
        && OrderService.CurrItem is not null && OrderService.CurrProductItem is not null)
        {
            // Info of the selected product with modifiers or sizes
            var item = OrderService.CurrItem;
            var product = OrderService.CurrProductItem;

            <div class="container">
            @* Button for to cancel selected product and to go back in the main page (only for test) *@
            @if (!OrderService.IsReleaseMode)
            {
                <div align="right">
                    <button @onclick="(e => { OrderService.CancelCurrSelectedItemWithModifiers(); StateOfPage.GoBack(); })"
                data-toggle="modal" data-target="#productModal" class="btn btn-link btn-sm btn-text-green">Отмена</button>
                </div>
            }
            <div align="center">
                <img class="img-thumbnail" style="margin-top:5px;margin-bottom:5px;" src="@product.ImageLink()"
                    alt="@product.Name" />
            </div>

            @* Restrictions of the selected product *@
            <h5>@product.Name</h5> <h6 style="color:lightgrey;">@(product.WeightAsString()) г</h6>
                <div class="row" style="--bs-gutter-x:0.6rem;">
                <div class="col">
                    <h5>В 100 граммах</h5>
                        <p>@(product.EnergyAsString()) Ккал · @(product.CarbsAsString()) Углеводы</p>
                </div>
                <div class="col">
                    @* Button for to decrease amount of the selected product *@
                    <div class="TlBlr_div TlBlrCounter_x TlBlrDesctopProductCard TlBlrCounter_y" style="height:48px;">
                        <button @onclick="(e => RemoveProductInSelectingModifiersAndAmountsForProductPageAsync())" class="TlBlrCounter_btn TlBlrCounter_decrement"
    data-testid="amount-select-decrement">
                        <svg width="1em" height="1em" viewBox="0 0 24 24" fill="none" class="TlBlrIcon_y TlBlrIcon_root TlBlrCounter_icon">
                            <path fill-rule="evenodd" clip-rule="evenodd" d="M6 12a1 1 0 0 0 1 1h10a1 1 0 1 0 0-2H7a1 1 0 0 0-1 1Z" fill="currentColor"></path>
                        </svg>
                        </button>

                        @* Number of the selected product *@
                        <span>@item.Amount</span>

                        @* Button for to increase amount of the selected product *@
                        <button @onclick="(e => AddProductInSelectingModifiersAndAmountsForProductPageAsync())" class="TlBlrCounter_btn TlBlrCounter_increment"
        data-testid="amount-select-increment">
                            <svg width="1em" height="1em" viewBox="0 0 24 24" fill="none" class="TlBlrIcon_y TlBlrIcon_root TlBlrCounter_icon">
                                <path fill-rule="evenodd" clip-rule="evenodd" d="M12 6a1 1 0 0 0-1 1v4H7a1 1 0 1 0 0 2h4v4a1 1 0 1 0 2 0v-4h4a1 1 0 1 0 0-2h-4V7a1 1 0 0 0-1-1Z"
                fill="currentColor"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            @* Description of the selected product *@
            @if (!string.IsNullOrEmpty(product.Description))
            {
                <h4>Описание</h4>
                <p>@product.Description</p>
            }

            @* Choosing sizes of the selected product *@
            @if (product.HaveSizesMoreThanOne())
            {
                <div style="padding-bottom: 3px;">
                    <h5>Размеры</h5>
                    @{
                        bool isFirst = true;
                    }
                    @foreach (var size in product.ItemSizes!)
                    {
                        <div class="form-check form-check-inline">
                            @if (isFirst)
                            {
                                <input class="form-check-input" type="radio" name="inlineRadioOptions" style="box-shadow:none;"
                                id="@size.SizeId" value="@size.SizeId" @onchange="OnChangingProductSizeAsync" checked>
                                isFirst = false;
                            }
                            else
                            {
                                <input class="form-check-input" type="radio" name="inlineRadioOptions" style="box-shadow:none;"
                                id="@size.SizeId" value="@size.SizeId" @onchange="OnChangingProductSizeAsync">
                            }
                            <label class="form-check-label" for="inlineRadio1">@size.SizeName</label>
                        </div>
                    }
                </div>
            }

            @{
                var modifierGroups = product.ModifierGroups();
            }
            @* Show modifiers groups *@
            @if (modifierGroups is not null)
            {
                foreach (var groupModifier in modifierGroups)
                {
                    <div class="row" style="--bs-gutter-x:0.6rem;">
                        <h5>@groupModifier.Name</h5>
                    </div>
                    @if (groupModifier.Items is not null)
                    {
                        foreach (var modifier in groupModifier.Items)
                        {
                            <div class="row mb-1" style="--bs-gutter-x:0.6rem;">
                                <div class="col-5">

                                    @* Just to add modifier to the selected product *@
                                    @if (!item.IsSelectedModifier(modifier.ItemId ?? Guid.Empty, groupModifier.ItemGroupId))
                                    {
                                        <div class="TlBlr_div TlBlrCounter_x TlBlrDesktopProductCard_footer TlBlrCounter_y">
                                            @if (!item.IsReachedMaxAmountOfGroupModifier(groupModifier.ItemGroupId ?? Guid.Empty, modifier.ItemId ?? Guid.Empty))
                                            {
                                                    <button @onclick="(e => AddModifierInSelectingModifiersAndAmountsForProductPageAsync(modifier.ItemId ?? Guid.Empty, groupModifier.ItemGroupId))"
                                                    class="TlBlrCounter_btn TlBlrCounter_onlyIncrement" data-testid="amount-select-increment">
                                                    <span>Добавить</span>
                                                </button>
                                            }
                                            else
                                            {
                                                <button data-testid="amount-select-increment" class="TlBlrCounter_btn TlBlrCounter_onlyIncrement" disabled>
                                                    <span>Добавить</span>
                                                </button>
                                            }
                                        </div>
                                    }
                                    @* Remove/add modifier to/from the selected product *@
                                    else
                                    {
                                        <div class="TlBlr_div TlBlrCounter_x TlBlrDesctopProductCard TlBlrCounter_y">
                                            <button @onclick="(e => RemoveModifierInSelectingModifiersAndAmountsForProductPageAsync(modifier.ItemId ?? Guid.Empty, groupModifier.ItemGroupId))"
                                                class="TlBlrCounter_btn TlBlrCounter_decrement" data-testid="amount-select-decrement">
                                                <svg width="1em" height="1em" viewBox="0 0 24 24" fill="none" class="TlBlrIcon_y TlBlrIcon_root TlBlrCounter_icon">
                                                    <path fill-rule="evenodd" clip-rule="evenodd" d="M6 12a1 1 0 0 0 1 1h10a1 1 0 1 0 0-2H7a1 1 0 0 0-1 1Z" fill="currentColor"></path>
                                                </svg>
                                            </button>
                                            
                                            @if (!item.IsReachedMaxAmountOfGroupModifier(groupModifier.ItemGroupId ?? Guid.Empty, modifier.ItemId ?? Guid.Empty))
                                            {
                                                <span>@(item.AmountOfModifier(modifier.ItemId ?? Guid.Empty, groupModifier.ItemGroupId))</span>
                                                    <button @onclick="(e => AddModifierInSelectingModifiersAndAmountsForProductPageAsync(modifier.ItemId ?? Guid.Empty, groupModifier.ItemGroupId))"
                                                class="TlBlrCounter_btn TlBlrCounter_increment" data-testid="amount-select-increment">
                                                    <svg width="1em" height="1em" viewBox="0 0 24 24" fill="none" class="TlBlrIcon_y TlBlrIcon_root TlBlrCounter_icon">
                                                        <path fill-rule="evenodd" clip-rule="evenodd" d="M12 6a1 1 0 0 0-1 1v4H7a1 1 0 1 0 0 2h4v4a1 1 0 1 0 2 0v-4h4a1 1 0 1 0 0-2h-4V7a1 1 0 0 0-1-1Z"
                                fill="currentColor"></path>
                                                    </svg>
                                                </button>
                                            }
                                            else
                                            {
                                                <span style="color:red;">@(item.AmountOfModifier(modifier.ItemId ?? Guid.Empty, groupModifier.ItemGroupId))</span>
                                                    <button data-testid="amount-select-increment" class="TlBlrCounter_btn TlBlrCounter_increment" disabled>
                                                    <svg width="1em" height="1em" viewBox="0 0 24 24" fill="none" class="TlBlrIcon_y TlBlrIcon_root TlBlrCounter_icon">
                                                        <path fill-rule="evenodd" clip-rule="evenodd" d="M12 6a1 1 0 0 0-1 1v4H7a1 1 0 1 0 0 2h4v4a1 1 0 1 0 2 0v-4h4a1 1 0 1 0 0-2h-4V7a1 1 0 0 0-1-1Z"
                                fill="currentColor"></path>
                                                    </svg>
                                                </button>  
                                            }
                                        </div>
                                    }

                                </div>

                                @* Price of the modifier *@
                                <div class="col">
                                    @{
                                        var modifierD = item.Modifiers?.FirstOrDefault(x => x.ProductId == modifier.ItemId);
                                    }
                                    <p>@modifierD?.Name</p>
                                    </div>
                                    <div align="right" class="col">
                                    @{
                                        var price = modifier.Price();
                                    }
                                    <p>@(price == 0 ? "Бесплатно" : $"₽{price}")</p>
                                </div>
                            </div>
                        }
                    }
                }
            }

            @* Complete adding the product with modifiers/sizes then to go back in the main page (only for test) *@
            @if (!OrderService.IsReleaseMode)
            {
                <br />
                <div>
                    @* If necessary modifiers has been selected then can go in the main page *@
                    @if (item.IsReachedMinAmountOfGroupModifiers() && item.IsReachedMinAmountOfModifiers())
                    {
                        <button @onclick="(e => StateOfPage.GoBack())" id="@OrderService.CurrItem.ProductId" data-toggle="modal" data-target="#productModal"
                            class="btn btn-success w-100">Добавить ₽@(OrderService.CurrItem.TotalPrice)</button>
                    }
                    else
                    {
                        <button id="@OrderService.CurrItem.ProductId" data-toggle="modal" data-target="#productModal"
                        class="btn btn-success w-100" disabled>Добавить ₽@(OrderService.CurrItem.TotalPrice)</button>
                    }
                </div>
            }
        </div>
        }
        // Show the page for:
        // - selecting the number of the product
        // This page is showing the product description and restrictions of the product
        // Notice! #0003
        else if (StateOfPage.PageTypeOfOrder == PageTypeOfOrder.SelectingAmountsForProducts
        && OrderService.CurrItem is not null && OrderService.CurrProductItem is not null)
        {
            // Info of the selected product with modifiers or sizes
            var item = OrderService.CurrItem;
            var product = OrderService.CurrProductItem;

            <div class="container">
                @* Button for to cancel selected product and to go back in the main page (only for test) *@
                @if (!OrderService.IsReleaseMode)
                {
                    <div align="right">
                        <button @onclick="(e => StateOfPage.GoBack())" 
            data-toggle="modal" data-target="#productModal" class="btn btn-link btn-sm btn-text-green">Отмена</button>
                    </div>
                }
                <div align="center">
                    <img class="img-thumbnail" style="margin-top:5px;margin-bottom:5px;" src="@product.ImageLink()"
            alt="@product.Name" />
                </div>

                @* Restrictions of the selected product *@
                <h5>@product.Name</h5> <h6 style="color:lightgrey;">@(product.WeightAsString()) г</h6>
                <div class="row" style="--bs-gutter-x:0.6rem;">
                    <div class="col">
                        <h5>В 100 граммах</h5>
                        <p>@(product.EnergyAsString()) Ккал · @(product.CarbsAsString()) Углеводы</p>
                    </div>
                    <div class="col">
                        @* Button for to decrease amount of the selected product *@
                        <div class="TlBlr_div TlBlrCounter_x TlBlrDesctopProductCard TlBlrCounter_y" style="height:48px;">
                            <button @onclick="(e => RemoveProductWithoutModifiersInSelectingAmountsForProductsPageAsync())" class="TlBlrCounter_btn TlBlrCounter_decrement"
            data-testid="amount-select-decrement">
                                <svg width="1em" height="1em" viewBox="0 0 24 24" fill="none" class="TlBlrIcon_y TlBlrIcon_root TlBlrCounter_icon">
                                    <path fill-rule="evenodd" clip-rule="evenodd" d="M6 12a1 1 0 0 0 1 1h10a1 1 0 1 0 0-2H7a1 1 0 0 0-1 1Z" fill="currentColor"></path>
                                </svg>
                            </button>

                            @* Number of the selected product *@
                            <span>@item.Amount</span>

                            @* Button for to increase amount of the selected product *@
                            <button @onclick="(e => AddProductWithoutModifiersInSelectingAmountsForProductsPageAsync())" class="TlBlrCounter_btn TlBlrCounter_increment"
            data-testid="amount-select-increment">
                                <svg width="1em" height="1em" viewBox="0 0 24 24" fill="none" class="TlBlrIcon_y TlBlrIcon_root TlBlrCounter_icon">
                                    <path fill-rule="evenodd" clip-rule="evenodd" d="M12 6a1 1 0 0 0-1 1v4H7a1 1 0 1 0 0 2h4v4a1 1 0 1 0 2 0v-4h4a1 1 0 1 0 0-2h-4V7a1 1 0 0 0-1-1Z"
                    fill="currentColor"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>     

                @* Description of the selected product *@
                @if (!string.IsNullOrEmpty(product.Description))
                {
                    <h4>Описание</h4>
                    <p>@product.Description</p>
                }

                @* Complete adding the product then to go back in the main page (only for test) *@
                @if (!OrderService.IsReleaseMode)
                {
                    <br />
                    <div>
                        <button @onclick="(e => StateOfPage.GoBack())" id="@item.ProductId" data-toggle="modal" data-target="#productModal"
            class="btn btn-success w-100">Добавить</button>
                    </div>
                }
            </div>
        }
        // Show the page for:
        // - changing the number of the products with sample IDs wich have modifiers/sizes
        // - empty selected positions
        // Notice! #0004
        else if (StateOfPage.PageTypeOfOrder == PageTypeOfOrder.ChangingSelectedProductsWithModifiers
        && OrderService.CurrentProduct is not null && OrderService.CurrProductItem is not null)
        {
            // To separate positions in this page
            bool hr = false;
            // Choose positions by only the product which being modified
            var items = OrderService.OrderInfo.CurrItems().Where(x => x.ProductId == OrderService.CurrentProduct.GetProductId());
            // Information about the product which being modified
            var product = OrderService.CurrProductItem;
            // Final sum of selected positions
            double totalSum = 0;

            <br />
            @if (items is not null && product is not null)
            {
                foreach (var item in items)
                {
                    if (hr)
                    {
                        <hr style="color:lightgrey;" />
                    }
                    else
                    {
                        hr = true;
                    }

                    <div class="row" style="--bs-gutter-x:0.6rem;">
                        <div class="col">
                            <img class="img-fluid rounded" src="@product!.ImageLink()" alt="@item.ProductName" />
                        </div>
                        <div class="col-6">
                            @{
                                // Get product name and size name if there is one
                                var sizeName = item.ProductSizeId is not null ? product!.ItemSizes?.FirstOrDefault(x => x.SizeId == item.ProductSizeId)?.SizeName
                                    : product!.HaveSizesMoreThanOne() ? product.ItemSizes?.FirstOrDefault()?.SizeName : null;
                            }

                            @* Product and size name *@
                            <p>@item.ProductName @sizeName</p>

                            @* Modifier names *@
                            @foreach (var modifier in item.SelectedModifiers())
                            {
                                <p> • @modifier.Name x@(modifier.Amount)</p>
                            }

                            @* Change the number of position *@
                            <div style="display: flex;">
                                <button @onclick="(e => RemoveProductItemInChangingSelectedProductsWithModifiersPageAsync(item.ProductId, item.PositionId ?? Guid.Empty))"
                                    data-toggle="modal" data-target="#productModal" class="btn btn-light" style="box-shadow:none;width:35px;border-radius:50%;background-color: #F5F4F2;">
                                    -
                                </button>
                                <p style="padding-left:10px;padding-right:10px;margin-bottom:0;margin-top:3%;">@(item.Amount) шт</p>
                                <button @onclick="(e => AddProductItemInChangingSelectedProductsWithModifiersPageAsync(item.ProductId, item.PositionId ?? Guid.Empty))"
                                    data-toggle="modal" data-target="#productModal" class="btn btn-light" style="box-shadow:none;width:35px;border-radius:50%;background-color: #F5F4F2;">
                                    +
                                </button>
                            </div>
                        </div>

                        @* Calculate total sum *@
                        <div align="right" class="col-2">
                            @{    
                                totalSum += item.TotalPrice ?? 0;           
                            }
                            <p>₽@totalSum</p>
                        </div>
                    </div>
                }
            }
        <h5 align="right" style="margin-top:20px;margin-bottom:5px;">Итого: ₽@totalSum</h5>

        @* Empty all selected positions and to go in the main page *@
        <br />
        <center>
            <button @onclick="(e => CancelCurrSimilarSelectedItemsWithModifiersAsync())" style="background-color:rgba(28,28,28,0);outline:none;border:0;width:42px;height:32px;">
                <svg xmlns="http://www.w3.org/2000/svg" class="Trash" viewBox="0 0 16 18.286" width="16" height="18.286">
                    <path d="M1.143 16.571a1.714 1.714 0 0 0 1.714 1.714h10.286a1.714 1.714 0 0 0 1.714 -1.714V4.571H1.143zm9.714 -9.143a0.571 0.571 0 0 1 1.143 0v8a0.571 0.571 0 0 1 -1.143 0zm-3.429 0a0.571 0.571 0 0 1 1.143 0v8a0.571 0.571 0 0 1 -1.143 0zm-3.429 0a0.571 0.571 0 0 1 1.143 0v8a0.571 0.571 0 0 1 -1.143 0zM15.429 1.143H11.143l-0.336 -0.668A0.857 0.857 0 0 0 10.039 0H5.957a0.847 0.847 0 0 0 -0.764 0.475L4.857 1.143H0.571A0.571 0.571 0 0 0 0 1.714v1.143a0.571 0.571 0 0 0 0.571 0.571h14.857a0.571 0.571 0 0 0 0.571 -0.571V1.714a0.571 0.571 0 0 0 -0.571 -0.571z"></path>
                </svg>
            </button>
        </center>
        }
        // Show the page for:
        // - changing the number for whole selected products and positions
        // - empty selected products and positions
        // - using coupons 
        // - spending bonuses
        // - selecting type of the delivery method
        // - filling in the address
        // - selecting the place of pickup
        // - adding a comment
        // - This page is showing selected products and positions wiht amounts, choosen modifiers and sizes, prices.
        // Final pay sum with discount procent too. Delivery method with typed address
        else if (StateOfPage.PageTypeOfOrder == PageTypeOfOrder.ShoppingCart)
        {   
            <div class="container-fluid">
                @* Just to show 'Trash' for a test *@
                @if (!OrderService.IsReleaseMode)
                {
                    <div class="row mt-1 mb-2" style="--bs-gutter-x:0.6rem;">
                        <div class="col">
                            <h1>Ваш заказ</h1>
                        </div>
                        <div align="right" class="col" style="padding-right:0px;padding-left:0px;">
                            <button style="background-color:rgba(28,28,28,0);outline:none;border:0;width:42px;height:32px;">
                                <svg xmlns="http://www.w3.org/2000/svg" class="Trash" viewBox="0 0 16 18.286" width="16" height="18.286">
                                    <path d="M1.143 16.571a1.714 1.714 0 0 0 1.714 1.714h10.286a1.714 1.714 0 0 0 1.714 -1.714V4.571H1.143zm9.714 -9.143a0.571 0.571 0 0 1 1.143 0v8a0.571 0.571 0 0 1 -1.143 0zm-3.429 0a0.571 0.571 0 0 1 1.143 0v8a0.571 0.571 0 0 1 -1.143 0zm-3.429 0a0.571 0.571 0 0 1 1.143 0v8a0.571 0.571 0 0 1 -1.143 0zM15.429 1.143H11.143l-0.336 -0.668A0.857 0.857 0 0 0 10.039 0H5.957a0.847 0.847 0 0 0 -0.764 0.475L4.857 1.143H0.571A0.571 0.571 0 0 0 0 1.714v1.143a0.571 0.571 0 0 0 0.571 0.571h14.857a0.571 0.571 0 0 0 0.571 -0.571V1.714a0.571 0.571 0 0 0 -0.571 -0.571z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                }
                @* Call the method to empty shopping cart *@
                else
                {
                    <div class="row mt-1 mb-2" style="--bs-gutter-x:0.6rem;">
                        <div class="col">
                            <h1>Ваш заказ</h1>
                        </div>
                        <div align="right" class="col" style="padding-right:0px;padding-left:0px;">
                            <button @onclick="(e => RemoveAllSelectedProductsInShoppingCartAsync())" style="background-color:rgba(28,28,28,0);outline:none;border:0;width:42px;height:32px;">
                                <svg xmlns="http://www.w3.org/2000/svg" class="Trash" viewBox="0 0 16 18.286" width="16" height="18.286">
                                    <path d="M1.143 16.571a1.714 1.714 0 0 0 1.714 1.714h10.286a1.714 1.714 0 0 0 1.714 -1.714V4.571H1.143zm9.714 -9.143a0.571 0.571 0 0 1 1.143 0v8a0.571 0.571 0 0 1 -1.143 0zm-3.429 0a0.571 0.571 0 0 1 1.143 0v8a0.571 0.571 0 0 1 -1.143 0zm-3.429 0a0.571 0.571 0 0 1 1.143 0v8a0.571 0.571 0 0 1 -1.143 0zM15.429 1.143H11.143l-0.336 -0.668A0.857 0.857 0 0 0 10.039 0H5.957a0.847 0.847 0 0 0 -0.764 0.475L4.857 1.143H0.571A0.571 0.571 0 0 0 0 1.714v1.143a0.571 0.571 0 0 0 0.571 0.571h14.857a0.571 0.571 0 0 0 0.571 -0.571V1.714a0.571 0.571 0 0 0 -0.571 -0.571z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                }

                @{
                    // To separate positions in this page
                    bool hr = false;
                }

                @* Show contents of the shopping cart *@
                @if (OrderService.OrderInfo.Items is not null)
                {
                    foreach (var item in OrderService.OrderInfo.Items)
                    {
                        var product = OrderService.DeliveryGeneralInfo.ProductById(item.ProductId);

                        if (hr)
                        {
                            <hr style="color:lightgrey;" />
                        }
                        else
                        {
                            hr = true;
                        }

                        // Get a size name of the position
                        var sizeName = item.ProductSizeId is not null ? product.ItemSizes?.FirstOrDefault(x => x.SizeId == item.ProductSizeId)?.SizeName
                        : product.HaveSizesMoreThanOne() ? product.ItemSizes?.FirstOrDefault()?.SizeName : null;

                        if (item.HaveModifiers())
                        {
                            <div class="row" style="--bs-gutter-x:0.6rem;">
                                <div class="col">
                                    <img class="img-fluid rounded" src="@product.ImageLink()" alt="@item.ProductName" />
                                </div>
                                <div class="col-6">
                                    <p>@item.ProductName @sizeName</p>
                                    @foreach (var modifier in item.SelectedModifiers())
                                    {
                                        <p> • @modifier.Name x@(modifier.Amount)</p>
                                    }
                                    <div style="display: flex;">
                                        <button @onclick="(e => RemoveProductItemInShoppingCartPageAsync(item.ProductId, item.PositionId))" data-toggle="modal" data-target="#productModal" class="btn btn-light"
    style="box-shadow:none;width:35px;border-radius:50%;background-color: #F5F4F2;">
                                            -
                                        </button>
                                        <p style="padding-left:10px;padding-right:10px;margin-bottom:0;margin-top:3%;">@(item.Amount) шт</p>
                                        <button @onclick="(e => AddProductItemInShoppingCartPageAsync(item.ProductId, item.PositionId))" data-toggle="modal" data-target="#productModal" class="btn btn-light"
    style="box-shadow:none;width:35px;border-radius:50%;background-color: #F5F4F2;">
                                            +
                                        </button>
                                    </div>
                                </div>

                                <div align="right" class="col-2">
                                    @{
                                        var totalSum = item.TotalPrice;
                                        var freeItems = OrderService.OrderInfo.DiscountFreeItems?.Where(id => id == item.PositionId);
                                    }

                                    @if (freeItems is not null && freeItems.Any())
                                    {
                                        double discountSum = 0;
                                        foreach (var freeItem in freeItems)
                                        {
                                            discountSum += item.Price ?? 0;
                                        }
                                        <del>₽@totalSum</del>
                                        <p>₽@(totalSum - discountSum)</p>
                                    }
                                    else
                                    {
                                        <p>₽@totalSum</p>
                                    }

                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="row" style="--bs-gutter-x:0.6rem;">
                                <div class="col">
                                    <img class="img-fluid rounded" src="@product.ImageLink()" alt="@item.ProductName" />
                                </div>
                                <div class="col-6">
                                    <p>@item.ProductName @sizeName</p>
                                    <div style="display: flex;">
                                        <button @onclick="(e => RemoveProductItemInShoppingCartPageAsync(item.ProductId, item.PositionId))" data-toggle="modal" data-target="#productModal" class="btn btn-light"
                                            style="box-shadow:none;width:35px;border-radius:50%;background-color: #F5F4F2;">
                                            -
                                        </button>
                                        <p style="padding-left:10px;padding-right:10px;margin-bottom:0;margin-top:3%;">@(item.Amount) шт</p>
                                        <button @onclick="(e => AddProductItemInShoppingCartPageAsync(item.ProductId, item.PositionId))" data-toggle="modal" data-target="#productModal" class="btn btn-light"
                                            style="box-shadow:none;width:35px;border-radius:50%;background-color: #F5F4F2;">
                                            +
                                        </button>
                                    </div>
                                </div>

                                <div align="right" class="col-2">
                                    @{
                                        var freeItems = OrderService.OrderInfo.DiscountFreeItems?.Where(id => id == item.PositionId);
                                    }

                                    @if (freeItems is not null && freeItems.Any())
                                    {
                                        double discountSum = 0;
                                        foreach (var freeItem in freeItems)
                                        {
                                            discountSum += item.Price ?? 0;
                                        }
                                        <del>₽@(item.Price * item.Amount)</del>
                                        <p>₽@(item.Price * item.Amount - discountSum)</p>
                                    }
                                    else
                                    {
                                        <p>₽@(item.Price * item.Amount)</p>
                                    }
                                </div>
                            </div>
                        }
                    }
                }

                @if (OrderService.OrderInfo.FreeItems is not null)
                {
                    foreach (var item in OrderService.OrderInfo.FreeItems)
                    {
                        var product = OrderService.DeliveryGeneralInfo.ProductById(item.ProductId);

                        <hr style="color:lightgrey;" />
                        <div class="row" style="--bs-gutter-x:0.6rem;">
                            <div class="col">
                                <img class="img-fluid rounded" src="@product.ImageLink()" alt="@product.Name" />
                            </div>
                            <div class="col-6">
                                <p>@item.ProductName</p>
                            </div>
                            <div align="right" class="col-2">
                                <p>🎁</p>
                            </div>
                        </div>
                    }
                }

            </div>
            <br />

            @if (OrderService.OrderInfo.DiscountSum > 0)
            {

                var discountProcent = OrderService.OrderInfo.DiscountProcent;
                bool isInteger = (int)(discountProcent * 100 % 100) == 0;
                <h5 style="margin-top:5px;">Скидка: -@(isInteger ? $"{discountProcent:f0}" : $"{discountProcent:f2}")%</h5>

                <div class="row mb-2" style="--bs-gutter-x:0.6rem;">
                    <div class="col">
                        <h5>Итого:</h5>
                    </div>
                    <div class="col" style="flex:0 0 auto;width:80%;">
                        <h6 align="left" style="padding-top:5px;"><del>₽@OrderService.OrderInfo.TotalSum</del></h6>
                        <h6 align="left">₽@(OrderService.OrderInfo.FinalSum)</h6>
                    </div>
                </div>
            }
            @if (OrderService.DeliveryGeneralInfo.UseCoupon && OrderService.IsLoyaltyProgramAvailableForProcess)
            {
                <div class="row" style="padding-bottom:5px;--bs-gutter-x:0.6rem;">
                        <div class="col">
                        <input class="comment" type="text" name="Coupon" placeholder="Введите промокод" @bind="@OrderService.OrderInfo.Coupon" />
                    </div>
                    <div class="col">
                        <button @onclick="CalculateLoyaltyProgramByCouponAsync" class="btn btn-light TlBlrCouponApply" style="box-shadow:none;background-color:#F5F4F2;height:100%;">
                            <span>Применить</span>
                        </button>
                    </div>
                </div>
            }

            @* !!! Change sum of pay on the main button of Telegram by using the wallet balance !!! *@
            if (OrderService.OrderInfo.WalletBalance > 0 && OrderService.OrderInfo.AllowedWalletSum > 0 && OrderService.IsLoyaltyProgramAvailableForProcess)
            {
                <h5>Бонусные баллы</h5>
                @* В зависимости от баланса изменять слово "баланс" *@
                <h6 style="padding-bottom: 3px;">У Вас накоплено @(OrderService.OrderInfo.WalletBalance) баллов</h6>
                <div class="row" style="--bs-gutter-x:0.6rem;padding-bottom: 5px;">
                    <div class="col-6" style="position:relative;">
                        <input type="range" class="form-range" style="margin:0;position:absolute;top:50%;left:50%;margin-right:-50%;transform:translate(-50%,-50%);
    padding-left:10px;padding-right:10px;"
               min="0" max="@(OrderService.OrderInfo.AllowedWalletSum)" id="customRangeForWalletBalance" value="@OrderService.OrderInfo.SelectedWalletSum"
                            @oninput="OnChangeAllowedWalletSum">
                    </div>
                    <div class="col-2" style="position:relative;">
                        <h5 style="margin:0;position:absolute;top:50%;left:50%;margin-right:-50%;transform:translate(-50%,-50%);">@(OrderService.OrderInfo.SelectedWalletSum)</h5>
                    </div>
                </div>
            }

            <div>
                <h5>Способ доставки</h5>
            </div>
            @if (OrderService.OrderInfo.ByCourier)
            {
                var address = OrderService.OrderInfo.Address!;
                var city = address.City;
                var street = address.Street;
                var house = address.House;
                var flat = address.Flat;
                var entrance = address.Entrance;
                var floor = address.Floor;

                <div class="btn-group" role="group" aria-label="Delivery type">
                    <button type="button" @onclick="(e => ChangeDeliveryTypeFlagAsync(true))" data-toggle="modal" data-target="#productModal" class="btn btn-success disabled">Доставка</button>
                    <button type="button" @onclick="(e => ChangeDeliveryTypeFlagAsync(false))" data-toggle="modal" data-target="#productModal" class="btn btn-secondary"
                        style="background-color:#c2c9cf;border-color: #c2c9cf;">Самовывоз</button>
                </div>
                <input class="comment" type="text" name="City" placeholder="Город" value="@city"
       @oninput="(e => { var res = e.Value.ToString(); OrderService.OrderInfo.Address!.City = res is null ? OrderService.OrderInfo.Address!.City : res; })" />
                <input class="comment" type="text" name="Street" placeholder="Улица" value="@street"
       @oninput="(e => { var res = e.Value.ToString(); OrderService.OrderInfo.Address!.Street = res is null ? OrderService.OrderInfo.Address!.Street : res; })" />
                <div style="display: flex;">
                    <input class="comment" style="width:49%;" type="text" name="House" placeholder="Дом" value="@house"
                    @oninput="(e => { var res = e.Value.ToString(); OrderService.OrderInfo.Address!.House = res is null ? OrderService.OrderInfo.Address!.House : res; })" />
                    <input class="comment" style="width:49%;margin-left:auto;margin-right:0em;" type="text" name="Flat" placeholder="Квартира" value="@flat"
           @oninput="(e => { var res = e.Value.ToString(); OrderService.OrderInfo.Address!.Flat = res is null ? OrderService.OrderInfo.Address!.Flat : res; })" />
                </div>
                <div style="display: flex;">
                    <input class="comment" style="width:49%;" type="text" name="Entrance" placeholder="Подъезд" value="@entrance"
           @oninput="(e => { var res = e.Value.ToString(); OrderService.OrderInfo.Address!.Entrance = res is null ? OrderService.OrderInfo.Address!.Entrance : res; })" />
                    <input class="comment" style="width:49%;margin-left:auto;margin-right:0em;" type="text" name="Floor" placeholder="Этаж" value="@floor"
           @oninput="(e => { var res = e.Value.ToString(); OrderService.OrderInfo.Address!.Floor = res is null ? OrderService.OrderInfo.Address!.Floor : res; })" />
                </div>
            }
            else
            {
                <div class="btn-group" role="group" aria-label="Delivery type">
                    <button @onclick="(e => ChangeDeliveryTypeFlagAsync(true))" data-toggle="modal" data-target="#productModal" class="btn btn-secondary"
                        style="background-color:#c2c9cf;border-color: #c2c9cf;">
                        Доставка
                    </button>
                    <button @onclick="(e => ChangeDeliveryTypeFlagAsync(false))" data-toggle="modal" data-target="#productModal" class="btn btn-success disabled">Самовывоз</button>
                </div>
                <div style="margin-top:10px;">
                    <select class="form-select" style="box-shadow:none;" aria-label="Default select example" @onchange="@OnSelectTerminalAsync">
                    @{
                        var delTerminal = OrderService.OrderInfo.DeliveryTerminal;
                    }
                    @if (delTerminal is not null)
                    {
                        <option id="@delTerminal.Id" selected>@(delTerminal.Name)</option>
                    }
                    else if (OrderService.OrderInfo.TerminalId is not null && OrderService.OrderInfo.TerminalId != Guid.Empty)
                    {
                        delTerminal = OrderService.DeliveryGeneralInfo.DeliveryTerminals?.FirstOrDefault(x => x.Id == OrderService.OrderInfo.TerminalId);
                        if (delTerminal is not null)
                        {
                            <option id="@delTerminal.Id" selected>@(delTerminal.Name)</option>
                        }
                        else
                        {
                            <option selected>Выберите улицу</option>
                        }
                    }
                    else
                    {
                        <option selected>Выберите улицу</option>
                    }
                    @if (OrderService.DeliveryGeneralInfo.DeliveryTerminals is not null)
                    {
                        foreach (var terminal in OrderService.DeliveryGeneralInfo.DeliveryTerminals)
                        {
                            <option value="@terminal.Id">@terminal.Name</option>
                        }
                    }
                    </select>
                </div>
            }

            @*Comment field*@
            <input class="comment" type="text" name="Comment" placeholder="Ваш комментарий..." @bind="@OrderService.OrderInfo.Comment"/>

            <div>
                <br/>
                @if (!OrderService.IsReleaseMode)
                {
                    <central>
                        @*The button for to pay the created order if the page isn't going to open in the Telegram app*@
                        @if (OrderService.OrderInfo.TotalSum < OrderService.DeliveryGeneralInfo.CurrOfRub)
                        {
                            <button data-toggle="modal" data-target="#productModal" class="btn btn-success" disabled>Pay ₽@(OrderService.OrderInfo.TotalSum)</button>
                        }
                        else
                        {
                            var sum = OrderService.OrderInfo.FinalSum;
                            <button @onclick="(e => PayOrderForTestAsync())" data-toggle="modal" data-target="#productModal" class="btn btn-success">Оплатить ₽@(sum)</button>
                        }
                    </central>
                }
            </div>
        }
        // Page to show information about the created order
        else if (StateOfPage.PageTypeOfOrder == PageTypeOfOrder.InfoAboutCreatedOrder && !OrderService.IsReleaseMode)
        {
            <p>@OrderService.InfoAboutCreatedOrderForTest()</p>
        }
    }
}
@* Waiting for the necessary data to be loaded from the API server *@
else {
    @* Show the preloader *@
    <div class=container4>
        <div class="dots-bars-2"></div>
    </div>
}

@code {
    //
    private IOrderService? OrderService { get; set; }
    //
    private ITwaNet? TwaNet { get; set; }
    //
    private IJsHelperService? JsHelperService { get; set; }
    //
    private StateOfPage? StateOfPage { get; set; }
    //
    private long TestChatId { get; } = 2098619539;
    //
    private bool IsLoadedGeneralInfo { get; set; } = false;


    // +
    protected override async Task OnInitializedAsync()
    {
        StateOfPage = new StateOfPage();

        try
        {
            JsHelperService = new JsHelperService();
            TwaNet = new TwaNet();
            var chatId = await TwaNet.TwaNetInitAsync(JsRuntime);
            OrderService = new OrderService(Http);
            await OrderService.OrderServiceInitAsync(chatId, OrderControllerPaths.RetrieveMainInfoForWebAppOrder);
            await TwaNet.SetMainBtnColorAsync(JsRuntime, OrderService.TlgMainBtnColor);
            IsLoadedGeneralInfo = true;

            // !!! Initialize and run it block after render page !!!
            StateHasChanged();
            if (OrderService.HaveSelectedProductsAtFirst())
            {
                var btnText = OrderService.DeliveryGeneralInfo.GetTlgWebAppBtnTxts().SelectingProducts;
                await TwaNet.SetMainButtonTextAsync(JsRuntime, btnText);
            }
            await ListenTwaBtnsAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
            // !!! Check error message for test chat ID !!!
            if (ex.Message.Contains("Cannot read properties of undefined (reading 'id')"))
            {
                try
                {
                    OrderService = new OrderService(Http);
                    await OrderService.OrderServiceInitAsync(TestChatId, OrderControllerPaths.RetrieveMainInfoForWebAppOrder);
                }
                catch (Exception iex)
                {
                    Console.WriteLine(iex.Message);
                }
            }
            else
            {
                StateOfPage.SetErrorStateForWebApp();
            }
        }
        finally
        {
            IsLoadedGeneralInfo = true;
        }
    }

    // Select group +
    private async Task AddCurrentGroupId(Guid id)
    {
        if (StateOfPage!.IsPageBlocked) return;

        try
        {
            OrderService!.CurrentGroupId = id;
            if (OrderService!.IsReleaseMode)
            {
                await TwaNet!.SetHapticFeedbackSelectionChangedAsync(JsRuntime);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
            StateOfPage.SetErrorStateForWebApp();
        }
    }

    // Add product in the main menu +
    private async Task AddProductItemInSelectingProductPageAsync(Guid productId)
    {       
        try
        {   
            if (StateOfPage!.IsPageBlocked) return;
            else if (OrderService!.IsReleaseMode)
            {
                await TwaNet!.SetHapticFeedbackSelectionChangedAsync(JsRuntime);
            }

            var productInfo = await OrderService!.AddProductItemInSelectingProductPageAsync(productId);
            var product = OrderService.DeliveryGeneralInfo.ProductById(productId);
            if (OrderService.IsReleaseMode)
            {
                if (product.HaveModifiersOrSizesMoreThanOne())
                {
                    StateOfPage.GoToPage(PageTypeOfOrder.SelectingModifiersAndAmountsForProduct);
                    var btnText = OrderService.DeliveryGeneralInfo.GetTlgWebAppBtnTxts().SelectingModifiersAndAmountsForProduct;
                    btnText = string.Format(btnText, productInfo.TotalSumOfSelectedProductWithModifiers());
                    await TwaNet!.SetMainButtonTextAsync(JsRuntime, btnText);
                    await TwaNet.ShowBackButtonAsync(JsRuntime);
                }
                else if (productInfo.IsFirstSelected)
                {
                    var btnText = OrderService.DeliveryGeneralInfo.GetTlgWebAppBtnTxts().SelectingProducts;
                    await TwaNet!.SetMainButtonTextAsync(JsRuntime, btnText);
                }
            }
            else if (product.HaveModifiersOrSizesMoreThanOne())
            {
                StateOfPage.GoToPage(PageTypeOfOrder.SelectingModifiersAndAmountsForProduct);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
        }
    }

    // Remove product in the main menu +
    private async Task RemoveProductItemInSelectingProductPageAsync(Guid productId)
    {
        try
        {
            if (StateOfPage!.IsPageBlocked) return;
            else if (OrderService!.IsReleaseMode)
            {
                await TwaNet!.SetHapticFeedbackSelectionChangedAsync(JsRuntime);
            }

            var product = OrderService!.DeliveryGeneralInfo.ProductById(productId, OrderService.CurrentGroupId);

            if (OrderService!.IsReleaseMode)
            {
                if (product.HaveModifiersOrSizesMoreThanOne())
                {
                    if ((await OrderService.RemoveProductItemWithModifiersInSelectingProductPageAsync(product)))
                    {
                        StateOfPage!.GoToPage(PageTypeOfOrder.ChangingSelectedProductsWithModifiers);
                        var btnText = OrderService.DeliveryGeneralInfo.GetTlgWebAppBtnTxts().ChangingSelectedProductsWithModifiers;
                        await TwaNet!.ShowBackButtonAsync(JsRuntime);
                        await TwaNet!.SetMainButtonTextAsync(JsRuntime, btnText);
                    }
                }
                else
                {
                    await OrderService!.RemoveProductItemInSelectingProductPageAsync(product);                    
                    if (!OrderService.OrderInfo.HaveSelectedProducts())
                    {
                        await TwaNet!.HideMainButtonAsync(JsRuntime);
                    }
                }
            }
            else
            {
                if (product.HaveModifiersOrSizesMoreThanOne())
                {
                    if ((await OrderService.RemoveProductItemWithModifiersInSelectingProductPageAsync(product)))
                        StateOfPage!.GoToPage(PageTypeOfOrder.ChangingSelectedProductsWithModifiers);
                }
                else
                {
                    await OrderService!.RemoveProductItemInSelectingProductPageAsync(product);
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
        }
    }

    // Increase an amount of product by ID in the shopping cart +
    private async Task AddProductItemInShoppingCartPageAsync(Guid productId, Guid? positionId = null)
    {
        try
        {
            if (StateOfPage!.IsPageBlocked) return;

            if (OrderService!.IsReleaseMode)
            {
                await TwaNet!.SetHapticFeedbackSelectionChangedAsync(JsRuntime);
                await TwaNet!.ShowProgressAsync(JsRuntime);

                await OrderService!.AddProductItemInShoppingCartPageAsync(JsRuntime, TwaNet!, productId, positionId);

                var btnText = OrderService.DeliveryGeneralInfo.GetTlgWebAppBtnTxts().ShoppingCart;
                btnText = string.Format(btnText, OrderService!.FinalSumOfOrder());
                await TwaNet!.HideProgressAsync(JsRuntime);
                await TwaNet!.SetMainButtonTextAsync(JsRuntime, btnText);
            }
            else await OrderService!.AddProductItemInShoppingCartPageAsync(productId, positionId);
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
            if (OrderService!.IsReleaseMode)
            {
                await TwaNet!.HideProgressAsync(JsRuntime);
            }
        }
    }

    // Decrease an amount of product by ID in the shopping cart +
    private async Task RemoveProductItemInShoppingCartPageAsync(Guid productId, Guid? positionId = null)
    {
        try
        {
            if (StateOfPage!.IsPageBlocked) return;

            if (OrderService!.IsReleaseMode)
            {
                await TwaNet!.SetHapticFeedbackSelectionChangedAsync(JsRuntime);
                await TwaNet!.ShowProgressAsync(JsRuntime);

                if ((await OrderService!.RemoveProductItemInShoppingCartPageAsync(JsRuntime, TwaNet!, productId, positionId)) is null &&
                !OrderService.OrderInfo.HaveSelectedProducts())
                {
                    StateOfPage.GoBack();
                    await TwaNet!.HideBackButtonAsync(JsRuntime);
                    await TwaNet!.HideMainButtonAsync(JsRuntime);
                }
                else
                {
                    var btnText = OrderService.DeliveryGeneralInfo.GetTlgWebAppBtnTxts().ShoppingCart;
                    btnText = string.Format(btnText, OrderService!.FinalSumOfOrder());
                    await TwaNet!.SetMainButtonTextAsync(JsRuntime, btnText);
                }
                await TwaNet!.HideProgressAsync(JsRuntime);
            }
            else if ((await OrderService!.RemoveProductItemInShoppingCartPageAsync(productId, positionId)) is null &&
                !OrderService.OrderInfo.HaveSelectedProducts())
            {
                StateOfPage.GoBack();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
            if (OrderService!.IsReleaseMode)
            {
                await TwaNet!.HideProgressAsync(JsRuntime);
            }
        }
    }

    // Increase an amount of product with modifiers by ID +
    private async Task AddProductItemInChangingSelectedProductsWithModifiersPageAsync(Guid productId, Guid positionId)
    {
        try
        {
            if (OrderService!.IsReleaseMode)
            {
                await TwaNet!.SetHapticFeedbackSelectionChangedAsync(JsRuntime);
            }

            await OrderService!.AddProductItemInChangingSelectedProductsWithModifiersPageAsync(productId, positionId);
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
        }
    }

    // Decrease an amount of product with modifiers by ID +
    private async Task RemoveProductItemInChangingSelectedProductsWithModifiersPageAsync(Guid productId, Guid positionId)
    {
        try
        {
            if (OrderService!.IsReleaseMode)
            {
                await TwaNet!.SetHapticFeedbackSelectionChangedAsync(JsRuntime);

                if ((await OrderService!.RemoveProductItemInChangingSelectedProductsWithModifiersPageAsync(productId, positionId)) is null)
                {
                    if (!OrderService.OrderInfo.CurrItems().Where(x => x.ProductId == productId).Any())
                    {
                        StateOfPage!.GoBack();
                        await TwaNet.HideBackButtonAsync(JsRuntime);

                        if (OrderService.OrderInfo.HaveSelectedProducts())
                        {
                            var btnText = OrderService.DeliveryGeneralInfo.GetTlgWebAppBtnTxts().SelectingProducts;
                            await TwaNet.SetMainButtonTextAsync(JsRuntime, btnText);
                        }
                        else
                        {
                            await TwaNet.HideMainButtonAsync(JsRuntime);
                        }
                    }
                }
            }
            else
            {
                if ((await OrderService!.RemoveProductItemInChangingSelectedProductsWithModifiersPageAsync(productId, positionId)) is null)
                {
                    if (!OrderService.OrderInfo.CurrItems().Where(x => x.ProductId == productId).Any())
                    {
                        StateOfPage!.GoBack();
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
        }
    }

    // Add a modifier to product by id +
    private async Task AddModifierInSelectingModifiersAndAmountsForProductPageAsync(Guid modifierId, Guid? modifierGroupId = null)
    {
        try
        {
            if (OrderService!.IsReleaseMode)
            {
                await TwaNet!.SetHapticFeedbackSelectionChangedAsync(JsRuntime);
                var item = OrderService!.AddModifierInSelectingModifiersAndAmountsForProductPageAsync(modifierId, modifierGroupId);
                var btnText = OrderService.DeliveryGeneralInfo.GetTlgWebAppBtnTxts().SelectingModifiersAndAmountsForProduct;
                btnText = string.Format(btnText, item.TotalPrice);
                await TwaNet!.SetMainButtonTextAsync(JsRuntime, btnText);
            }
            else
            {
                OrderService!.AddModifierInSelectingModifiersAndAmountsForProductPageAsync(modifierId, modifierGroupId);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
        }
    }

    // Remove a modifier from product by id +
    private async Task RemoveModifierInSelectingModifiersAndAmountsForProductPageAsync(Guid modifierId, Guid? modifierGroupId = null)
    {
        try
        {
            if (OrderService!.IsReleaseMode)
            {
                await TwaNet!.SetHapticFeedbackSelectionChangedAsync(JsRuntime);
                var item = OrderService!.RemoveModifierInSelectingModifiersAndAmountsForProductPageAsync(modifierId, modifierGroupId);
                var btnText = OrderService.DeliveryGeneralInfo.GetTlgWebAppBtnTxts().SelectingModifiersAndAmountsForProduct;
                btnText = string.Format(btnText, item.TotalPrice);
                await TwaNet!.SetMainButtonTextAsync(JsRuntime, btnText);
            }
            else
            {
                OrderService!.RemoveModifierInSelectingModifiersAndAmountsForProductPageAsync(modifierId, modifierGroupId);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
        }
    }

    // Add product in the modifier menu +
    private async Task AddProductInSelectingModifiersAndAmountsForProductPageAsync()
    {
        try
        {
            if (OrderService!.IsReleaseMode)
            {
                await TwaNet!.SetHapticFeedbackSelectionChangedAsync(JsRuntime);
                var item = OrderService.AddProductInSelectingModifiersAndAmountsForProductPageAsync();
                var btnText = OrderService.DeliveryGeneralInfo.GetTlgWebAppBtnTxts().SelectingModifiersAndAmountsForProduct;
                btnText = string.Format(btnText, item.TotalPrice);
                await TwaNet!.SetMainButtonTextAsync(JsRuntime, btnText);
            }
            else
            {
                OrderService.AddProductInSelectingModifiersAndAmountsForProductPageAsync();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
        }
    }

    // Remove product in the modifier menu +
    private async Task RemoveProductInSelectingModifiersAndAmountsForProductPageAsync()
    {
        try
        {
            if (OrderService!.IsReleaseMode)
            {
                await TwaNet!.SetHapticFeedbackSelectionChangedAsync(JsRuntime);
                var item = OrderService.RemoveProductInSelectingModifiersAndAmountsForProductPageAsync();
                if (item is null)
                {
                    StateOfPage!.GoBack();
                    if (OrderService.OrderInfo.HaveSelectedProducts())
                    {
                        var btnText = OrderService.DeliveryGeneralInfo.GetTlgWebAppBtnTxts().SelectingProducts;
                        await TwaNet.SetMainButtonTextAsync(JsRuntime, btnText);
                    }
                    else
                    {
                        await TwaNet.HideMainButtonAsync(JsRuntime);
                    }
                    await TwaNet.HideBackButtonAsync(JsRuntime);
                }
                else
                {
                    var btnText = OrderService.DeliveryGeneralInfo.GetTlgWebAppBtnTxts().SelectingModifiersAndAmountsForProduct;
                    btnText = string.Format(btnText, item.TotalPrice);
                    await TwaNet!.SetMainButtonTextAsync(JsRuntime, btnText);
                }
            }
            else
            {
                if (OrderService.RemoveProductInSelectingModifiersAndAmountsForProductPageAsync() is null)
                {
                    StateOfPage!.GoBack();
                }
            }
            await OrderService.SendChangedOrderModelToServerAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
        }
    }

    // +
    public async Task AddProductWithoutModifiersForSelectingAmountsForProductsPageAsync(Guid productId)
    {
        try
        {
            if (OrderService!.IsReleaseMode)
            {
                await TwaNet!.SetHapticFeedbackSelectionChangedAsync(JsRuntime);
                StateOfPage!.GoToPage(PageTypeOfOrder.SelectingAmountsForProducts);
                var res = OrderService.AddProductWithoutModifiersForSelectingAmountsForProductsPageAsync(productId);
                var btnText = OrderService.DeliveryGeneralInfo.GetTlgWebAppBtnTxts().SelectingAmountsForProducts;
                btnText = string.Format(btnText, res.Item.TotalPrice);
                await TwaNet!.SetMainButtonTextAsync(JsRuntime, btnText);
                await TwaNet.ShowBackButtonAsync(JsRuntime);
            }
            else
            {
                StateOfPage!.GoToPage(PageTypeOfOrder.SelectingAmountsForProducts);
                OrderService.AddProductWithoutModifiersForSelectingAmountsForProductsPageAsync(productId);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
        }
    }

    // Add product +
    private async Task AddProductWithoutModifiersInSelectingAmountsForProductsPageAsync()
    {
        try
        {
            if (OrderService!.IsReleaseMode)
            {
                await TwaNet!.SetHapticFeedbackSelectionChangedAsync(JsRuntime);
                var res = OrderService.AddProductWithoutModifiersInSelectingAmountsForProductsPageAsync();
                var btnText = OrderService.DeliveryGeneralInfo.GetTlgWebAppBtnTxts().SelectingAmountsForProducts;
                btnText = string.Format(btnText, res.Item.TotalPrice);
                await TwaNet!.SetMainButtonTextAsync(JsRuntime, btnText);
            }
            else
            {
                OrderService.AddProductWithoutModifiersInSelectingAmountsForProductsPageAsync();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
        }
    }

    // Remove product +
    private async Task RemoveProductWithoutModifiersInSelectingAmountsForProductsPageAsync()
    {
        try
        {
            if (OrderService!.IsReleaseMode)
            {
                await TwaNet!.SetHapticFeedbackSelectionChangedAsync(JsRuntime);
                var res = OrderService.RemoveProductWithoutModifiersInSelectingAmountsForProductsPageAsync();

                if (res is null)
                {
                    StateOfPage!.GoBack();
                    if (OrderService.OrderInfo.HaveSelectedProducts())
                    {
                        var btnText = OrderService.DeliveryGeneralInfo.GetTlgWebAppBtnTxts().SelectingProducts;
                        await TwaNet!.SetMainButtonTextAsync(JsRuntime, btnText);
                    }
                    else
                    {
                        await TwaNet.HideMainButtonAsync(JsRuntime);
                    }
                    await TwaNet.HideBackButtonAsync(JsRuntime);
                }
                else
                {
                    var btnText = OrderService.DeliveryGeneralInfo.GetTlgWebAppBtnTxts().SelectingAmountsForProducts;
                    btnText = string.Format(btnText, res.Item.TotalPrice);
                    await TwaNet!.SetMainButtonTextAsync(JsRuntime, btnText);
                }
            }
            else
            {
                if (OrderService.RemoveProductWithoutModifiersInSelectingAmountsForProductsPageAsync() is null)
                {
                    StateOfPage!.GoBack();
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
        }
    }

    // Set the order to view status (use only in web mode) +
    private async Task ViewOrderOfTestMode()
    {
        try
        {
            StateOfPage!.GoToPage(PageTypeOfOrder.ShoppingCart);
            await OrderService!.CalculateLoayltyProgramAndAllowedSumAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
        }
    }

    // Tracking the click of the main telegram button +
    private async Task TelegramHandlerMainButtonAsync()
    {
        Console.WriteLine(typeof(Index).FullName!, nameof(TelegramHandlerMainButtonAsync), "Listening the TelegramBot main button");

        while (true)
        {
            StateOfPage!.IsPageBlocked = false;
            await TwaNet!.HideProgressAsync(JsRuntime);

            try
            {
                await TwaNet!.ListenMainButtonAsync(JsRuntime);
                await TwaNet.SetHapticFeedbackImpactOccurredAsync(JsRuntime, HapticFeedbackImpactOccurredType.light);

                if (StateOfPage!.PageTypeOfOrder == PageTypeOfOrder.SelectingProducts)
                {
                    await TwaNet!.ShowProgressAsync(JsRuntime);
                    if (OrderService!.DeliveryGeneralInfo.UseIikoBizProgram)
                    {
                        if (!(await OrderService.CalculateLoyaltyProgramAndAllowedSumAndCheckAvailableMinSumForPayAsync(JsRuntime, TwaNet))) continue;
                    }
                    else
                    {
                        if (!(await OrderService!.CheckAvailableMinSumForPayAsync(JsRuntime, TwaNet))) continue;
                    }

                    StateOfPage.GoToPage(PageTypeOfOrder.ShoppingCart);
                    StateHasChanged();

                    await JsHelperService!.ScrollToTopAsync(JsRuntime);
                    await TwaNet.ShowBackButtonAsync(JsRuntime);
                    var btnTxt = string.Format(OrderService.DeliveryGeneralInfo.GetTlgWebAppBtnTxts().ShoppingCart, OrderService.OrderInfo.FinalSum);
                    await TwaNet.SetMainButtonTextAsync(JsRuntime, btnTxt);
                    await TwaNet!.HideProgressAsync(JsRuntime);
                }
                else if (StateOfPage!.PageTypeOfOrder == PageTypeOfOrder.SelectingModifiersAndAmountsForProduct)
                {
                    if (!OrderService!.CheckSelectingModifiersInSelectingModifiersAndAmountsForProductPageAsync())
                    {
                        var popupMsg = OrderService.DeliveryGeneralInfo.GetTlgWebAppPopupMessages().IncorrectSelectedModifier ?? throw new InfoException(typeof(OrderService).FullName!,
                            nameof(TelegramHandlerMainButtonAsync), nameof(Exception), $"{typeof(TlgWebAppPopupMessages).FullName!}." +
                            $"{nameof(TlgWebAppPopupMessages.IncorrectSelectedModifier)}", ExceptionType.Null);

                        await TwaNet.ShowOkPopupMessageAsync(JsRuntime, popupMsg.Title, popupMsg.Title, HapticFeedBackNotificationType.warning);
                        continue;
                    }

                    StateOfPage.GoBack();
                    StateHasChanged();

                    var btnText = OrderService!.DeliveryGeneralInfo.GetTlgWebAppBtnTxts().SelectingProducts;
                    await TwaNet.SetMainButtonTextAsync(JsRuntime, btnText);
                    await TwaNet.HideBackButtonAsync(JsRuntime);

                    await OrderService!.SendChangedOrderModelToServerAsync();
                }
                else if (StateOfPage!.PageTypeOfOrder == PageTypeOfOrder.SelectingAmountsForProducts)
                {
                    StateOfPage.GoBack();
                    StateHasChanged();

                    await TwaNet.HideBackButtonAsync(JsRuntime);
                    var btnText = OrderService!.DeliveryGeneralInfo.GetTlgWebAppBtnTxts().SelectingProducts;
                    await TwaNet.SetMainButtonTextAsync(JsRuntime, btnText);
                    await OrderService!.SendChangedOrderModelToServerAsync();
                }
                else if (StateOfPage!.PageTypeOfOrder == PageTypeOfOrder.ChangingSelectedProductsWithModifiers)
                {
                    StateOfPage.GoBack();
                    StateHasChanged();

                    await TwaNet.HideBackButtonAsync(JsRuntime);
                    var btnText = OrderService!.DeliveryGeneralInfo.GetTlgWebAppBtnTxts().SelectingProducts;
                    await TwaNet.SetMainButtonTextAsync(JsRuntime, btnText);
                    await OrderService!.SendChangedOrderModelToServerAsync();
                }
                else if (StateOfPage!.PageTypeOfOrder == PageTypeOfOrder.ShoppingCart)
                {
                    StateOfPage!.IsPageBlocked = true;
                    await TwaNet!.ShowProgressAsync(JsRuntime);

                    if (!(await OrderService!.IsNecessaryDataOfOrderCorrect(JsRuntime, TwaNet)))
                    {
                        await TwaNet!.HideProgressAsync(JsRuntime);
                        continue;
                    }

                    if ((await OrderService.IsWalletBalanceChangedInIikoCardAsync()))
                    {
                        await TwaNet!.HideProgressAsync(JsRuntime);
                        var btnTxt = OrderService.DeliveryGeneralInfo.GetTlgWebAppPopupMessages().WalletBalanceChangedInIikoBiz
                            ?? throw new InfoException(typeof(OrderService).FullName!, nameof(TelegramHandlerMainButtonAsync), nameof(Exception),
                            $"{typeof(TlgWebAppPopupMessages).FullName!}.{nameof(TlgWebAppPopupMessages.WalletBalanceChangedInIikoBiz)}", ExceptionType.Null);
                        await TwaNet.ShowOkPopupMessageAsync(JsRuntime, btnTxt.Title, btnTxt.Description, HapticFeedBackNotificationType.warning);
                        continue;
                    }

                    // Save changed order info by using CreateInvoiceLinkAsync method
                    await OrderService!.SendChangedOrderModelToServerAsync();
                    await OrderService!.CreateInvoiceLinkAsync(JsRuntime, TwaNet);
                    await TwaNet!.HideProgressAsync(JsRuntime);
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message);

                // !!! Ask the user abount to close web app or left it !!!
                await TryToCloseWebAppAsync();
            }
        }
    }

    // Tracking the click of the back telegram button +
    private async Task TelegramHandlerBackButtonAsync()
    {
        // Wait a callback from the telegram
        Console.WriteLine(typeof(Index).FullName!, nameof(TelegramHandlerBackButtonAsync), "Listening the TelegramBot back button");

        while (true)
        {
            try
            {
                await TwaNet!.ListenBackButtonAsync(JsRuntime);
                await TwaNet.SetHapticFeedbackImpactOccurredAsync(JsRuntime, HapticFeedbackImpactOccurredType.light);

                if (StateOfPage!.IsPageBlocked)
                {
                    continue;
                }
                else if (StateOfPage.PageTypeOfOrder == PageTypeOfOrder.SelectingModifiersAndAmountsForProduct)
                {
                    OrderService!.CancelCurrSelectedItemWithModifiers();

                    StateOfPage.GoBack();
                    StateHasChanged();

                    if (OrderService.OrderInfo.HaveSelectedProducts())
                    {
                        var btnText = OrderService!.DeliveryGeneralInfo.GetTlgWebAppBtnTxts().SelectingProducts;
                        await TwaNet.SetMainButtonTextAsync(JsRuntime, btnText);
                    }
                    else await TwaNet.HideMainButtonAsync(JsRuntime);
                    await TwaNet.HideBackButtonAsync(JsRuntime);
                }
                else if (StateOfPage.PageTypeOfOrder == PageTypeOfOrder.SelectingAmountsForProducts)
                {
                    StateOfPage.GoBack();
                    StateHasChanged();

                    var btnText = OrderService!.DeliveryGeneralInfo.GetTlgWebAppBtnTxts().SelectingProducts;
                    await TwaNet.SetMainButtonTextAsync(JsRuntime, btnText);
                    await TwaNet.HideBackButtonAsync(JsRuntime);
                }
                else if (StateOfPage.PageTypeOfOrder == PageTypeOfOrder.ChangingSelectedProductsWithModifiers)
                {
                    StateOfPage.GoBack();
                    StateHasChanged();

                    var btnText = OrderService!.DeliveryGeneralInfo.GetTlgWebAppBtnTxts().SelectingProducts;
                    await TwaNet.SetMainButtonTextAsync(JsRuntime, btnText);
                    await TwaNet.HideBackButtonAsync(JsRuntime);
                }
                else if (StateOfPage.PageTypeOfOrder == PageTypeOfOrder.ShoppingCart)
                {
                    StateOfPage.GoBack();
                    StateHasChanged();

                    var btnText = OrderService!.DeliveryGeneralInfo.GetTlgWebAppBtnTxts().SelectingProducts;
                    await TwaNet.SetMainButtonTextAsync(JsRuntime, btnText);
                    await TwaNet.HideBackButtonAsync(JsRuntime);
                    await OrderService!.SendChangedOrderModelToServerAsync();
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message);

                // !!! Ask the user abount to close web app or left it !!!
                await TryToCloseWebAppAsync();
            }
        }
    }

    // +
    private async Task TryToCloseWebAppAsync()
    {
        try
        {
            await TwaNet!.CloseWebAppAsync(JsRuntime);
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
            StateOfPage!.SetErrorStateForWebApp();
        }
    }

    // Pay the completed order (use only in web mode) +
    private async Task PayOrderForTestAsync()
    {
        try
        {
            await OrderService!.CreateInvoiceUrlLinkAsync();
            StateOfPage!.GoToPage(PageTypeOfOrder.InfoAboutCreatedOrder);
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
        }
    }

    // Listen handler events of JS (***Testing mode***) +
    async Task ListenTwaBtnsAsync()
    {
        try
        {
            Console.WriteLine(typeof(Index).FullName!, nameof(ListenTwaBtnsAsync), "Listening the main button of the TelegramBot");
            // Call handler to catch the click of telegram button
            var mainButtonTask = TelegramHandlerMainButtonAsync();
            var backButtonTask = TelegramHandlerBackButtonAsync();
            await mainButtonTask;
            await backButtonTask;
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
            StateOfPage!.SetErrorStateForWebApp();
        }
    }

    // Receive terminal id from html form (beta) +
    private async Task OnSelectTerminalAsync(ChangeEventArgs e)
    {
        try
        {
            if (OrderService!.IsReleaseMode)
            {
                await TwaNet!.SetHapticFeedbackSelectionChangedAsync(JsRuntime);
            }

            var arg = Convert.ToString(e.Value);
            if (!string.IsNullOrEmpty(arg))
            {
                var id = Guid.Parse(arg);
                if (OrderService!.IsReleaseMode)
                {
                    if (OrderService.IsLoyaltyProgramAvailableForProcess)
                    {
                        await TwaNet!.ShowProgressAsync(JsRuntime);
                        await OrderService!.SetPickupTerminalWithLoyaltyProgramProcessAsync(JsRuntime, TwaNet!, id);

                        var btnText = OrderService.DeliveryGeneralInfo.GetTlgWebAppBtnTxts().ShoppingCart;
                        btnText = string.Format(btnText, OrderService!.FinalSumOfOrder());
                        await TwaNet!.SetMainButtonTextAsync(JsRuntime, btnText);
                        await TwaNet!.HideProgressAsync(JsRuntime);
                    }
                    else OrderService.SetPickupTerminal(id);
                }
                else await OrderService!.SetPickupTerminalWithLoyaltyProgramProcessAsync(id);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
            if (OrderService!.IsReleaseMode)
            {
                await TwaNet!.HideProgressAsync(JsRuntime);
            }
        }
    }

    // Calculate discount program +
    private async Task CalculateLoyaltyProgramByCouponAsync()
    {
        try
        {
            if (OrderService!.IsReleaseMode)
            {
                await TwaNet!.SetHapticFeedbackSelectionChangedAsync(JsRuntime);
                await TwaNet!.ShowProgressAsync(JsRuntime);
                await OrderService.CalculateLoayltyProgramAndAllowedSumAsync(JsRuntime, TwaNet);

                var btnText = OrderService.DeliveryGeneralInfo.GetTlgWebAppBtnTxts().ShoppingCart;
                btnText = string.Format(btnText, OrderService!.FinalSumOfOrder());
                await TwaNet!.SetMainButtonTextAsync(JsRuntime, btnText);
                await TwaNet!.HideProgressAsync(JsRuntime);
            }
            else await OrderService.CalculateLoayltyProgramAndAllowedSumAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
            if (OrderService!.IsReleaseMode)
            {
                await TwaNet!.HideProgressAsync(JsRuntime);
            }
        }
    }

    // +
    private async Task ChangeDeliveryTypeFlagAsync(bool byCourier)
    {
        try
        {
            OrderService!.OrderInfo.ByCourier = byCourier;
            if (OrderService!.IsReleaseMode)
            {
                await TwaNet!.SetHapticFeedbackSelectionChangedAsync(JsRuntime);
                if (OrderService.IsLoyaltyProgramAvailableForProcess)
                {
                    await TwaNet!.ShowProgressAsync(JsRuntime);
                    await OrderService.CalculateLoayltyProgramAndAllowedSumAsync(JsRuntime, TwaNet);

                    var btnText = OrderService.DeliveryGeneralInfo.GetTlgWebAppBtnTxts().ShoppingCart;
                    btnText = string.Format(btnText, OrderService!.FinalSumOfOrder());
                    await TwaNet!.SetMainButtonTextAsync(JsRuntime, btnText);
                    await TwaNet!.HideProgressAsync(JsRuntime);
                }
            }
            else await OrderService.CalculateLoayltyProgramAndAllowedSumAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
            if (OrderService!.IsReleaseMode)
            {
                await TwaNet!.HideProgressAsync(JsRuntime);
            }
        }
    }

    // Remove all selected products in the shopping cart +
    private async Task RemoveAllSelectedProductsInShoppingCartAsync()
    {
        try
        {
            if (OrderService!.IsReleaseMode)
            {
                var popupMsg = OrderService.DeliveryGeneralInfo.GetTlgWebAppPopupMessages().EmptyShoppingCart ?? throw new InfoException(typeof(Index).FullName!,
                    nameof(RemoveAllSelectedProductsInShoppingCartAsync), nameof(Exception), $"{typeof(TlgWebAppPopupMessages).FullName!}." +
                    $"{nameof(TlgWebAppPopupMessages.EmptyShoppingCart)}", ExceptionType.Null);

                const string yes = "0";
                const string no = "1";

                var popupPrms = new PopupParams(popupMsg.Title, popupMsg.Description, new List<PopupButton>
                {
                    new PopupButton(yes, "Да", PopupButtonType.destructive),
                    new PopupButton(no, "Отмена", PopupButtonType.destructive)
                });

                var res = await TwaNet!.ShowPopupParamsAsync(JsRuntime, popupPrms, HapticFeedBackNotificationType.warning, HapticFeedbackImpactOccurredType.soft);
                if (res == yes)
                {
                    StateOfPage!.GoBack();
                    await OrderService.RemoveAllSelectedProductsInShoppingCartPageAsync();
                    await TwaNet.HideMainButtonAsync(JsRuntime);
                    await TwaNet.HideBackButtonAsync(JsRuntime);
                }
            }
            else
            {
                StateOfPage!.GoBack();
                await OrderService.RemoveAllSelectedProductsInShoppingCartPageAsync();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
        }
    }

    // Remove selected products with modifiers by ID +
    private async Task CancelCurrSimilarSelectedItemsWithModifiersAsync()
    {
        try
        {
            if (OrderService!.IsReleaseMode)
            {
                var popupMsg = OrderService.DeliveryGeneralInfo.GetTlgWebAppPopupMessages().EmptyShoppingCart ?? throw new InfoException(typeof(Index).FullName!,
                    nameof(CancelCurrSimilarSelectedItemsWithModifiersAsync), nameof(Exception), $"{typeof(TlgWebAppPopupMessages).FullName!}." +
                    $"{nameof(TlgWebAppPopupMessages.EmptySelectedItemsWithModifiers)}", ExceptionType.Null);

                const string yes = "0";
                const string no = "1";

                var popupPrms = new PopupParams(popupMsg.Title, popupMsg.Description, new List<PopupButton>
                {
                    new PopupButton(yes, "Да", PopupButtonType.destructive),
                    new PopupButton(no, "Отмена", PopupButtonType.destructive)
                });

                var res = await TwaNet!.ShowPopupParamsAsync(JsRuntime, popupPrms, HapticFeedBackNotificationType.warning, HapticFeedbackImpactOccurredType.soft);
                if (res == yes)
                {
                    StateOfPage!.GoBack();
                    await OrderService.CancelCurrSimilarSelectedItemsWithModifiersAsync();
                    if (OrderService.OrderInfo.HaveSelectedProducts())
                    {
                        var btnText = OrderService.DeliveryGeneralInfo.GetTlgWebAppBtnTxts().SelectingProducts;
                        await TwaNet.SetMainButtonTextAsync(JsRuntime, btnText);
                    }
                    else
                    {
                        await TwaNet.HideMainButtonAsync(JsRuntime);
                    }
                    await TwaNet.HideBackButtonAsync(JsRuntime);
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
        }
    }

    // +
    private async Task OnChangingProductSizeAsync(ChangeEventArgs arg)
    {
        if (OrderService!.IsReleaseMode)
        {
            await TwaNet!.SetHapticFeedbackImpactOccurredAsync(JsRuntime, HapticFeedbackImpactOccurredType.soft);
        }

        var value = arg.Value?.ToString();
        if (value is not null && Guid.TryParse(value, out Guid sizeId))
        {
            try
            {
                var item = OrderService.ChangeProductSize(sizeId);

                if (OrderService!.IsReleaseMode)
                {
                    var btnText = OrderService.DeliveryGeneralInfo.GetTlgWebAppBtnTxts().SelectingModifiersAndAmountsForProduct;
                    btnText = string.Format(btnText, item.TotalPrice);
                    await TwaNet!.SetMainButtonTextAsync(JsRuntime, btnText);
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message);
            }
        }
    }

    // +
    private async void OnChangeAllowedWalletSum(ChangeEventArgs arg)
    {
        var value = arg.Value?.ToString();
        if (value is not null && Int32.TryParse(value, out var walletSum))
        {
            OrderService!.OrderInfo.SelectedWalletSum = walletSum;
            if (OrderService.IsReleaseMode)
            {
                var btnTxt = string.Format(OrderService.DeliveryGeneralInfo.GetTlgWebAppBtnTxts().ShoppingCart, OrderService.OrderInfo.FinalSum - walletSum);
                await TwaNet!.SetMainButtonTextAsync(JsRuntime, btnTxt);
            }
        }
    }
}